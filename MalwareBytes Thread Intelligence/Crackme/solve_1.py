from PIL import Image


def zero_bits(val, pos):
    return val >> pos << pos


def keep_bits(val, pos):
    return val & ~zero_bits(val, pos)


img = Image.open('mb_logo_star.PNG')


print(img.size)

arr_const = []
for i in range(700):
    for j in range(700):
        p = img.getpixel((i, j))
        arr_const.append((keep_bits(p[0], 3)) | (
            keep_bits(p[1], 3) << 3) | (keep_bits(p[2], 2) << 6))

# str_key = 'This program cannot be run in DOS mode'

password_1 = ''
# for i in range(len(str_key)):
#     password_1+=chr(arr_const[0x4e+i]^ord(str_key[i]))
# print(password_1)

# 'r_pe_and_keep_going!easy_level_one_alm'

# f = open('MBCrackme.exe','rb')

# str = f.read()

# for i in range(0x31):
#     password_1+=chr(arr_const[i]^str[i])
# print(password_1)

final_key = 'easy_level_one_almost_done_xor_pe_and_keep_going!'

with open('level2.exe', 'wb') as file_out:
    for i in range(241152):
        file_out.write(bytes([arr_const[i] ^ ord(final_key[i % len(final_key)])]))
